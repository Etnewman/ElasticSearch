{
    "description" : "Pipeline for parsing Kibana logs",
    "processors" : [
      {
        "set" : {
          "value" : "{{_ingest.timestamp}}",
          "field" : "event.ingested"
        }
      },
      {
        "set" : {
          "copy_from" : "@timestamp",
          "field" : "event.created"
        }
      },
      {
        "rename" : {
          "field" : "json",
          "target_field" : "kibana.log.meta"
        }
      },
      {
        "date" : {
          "target_field" : "@timestamp",
          "field" : "kibana.log.meta.@timestamp",
          "formats" : [
            "ISO8601"
          ]
        }
      },
      {
        "remove" : {
          "field" : "kibana.log.meta.@timestamp"
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.message",
          "target_field" : "message"
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.state",
          "target_field" : "kibana.log.state",
          "ignore_missing" : true
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.pid",
          "target_field" : "process.pid"
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.tags",
          "target_field" : "kibana.log.tags"
        }
      },
      {
        "rename" : {
          "target_field" : "http.response.status_code",
          "ignore_missing" : true,
          "field" : "kibana.log.meta.res.statusCode"
        }
      },
      {
        "script" : {
          "source" : "ctx.event.duration = Math.round(ctx.kibana.log.meta.res.responseTime * 1000000L)",
          "if" : "ctx?.kibana?.log?.meta?.res?.responseTime != null",
          "lang" : "painless"
        }
      },
      {
        "remove" : {
          "field" : "kibana.log.meta.res.responseTime",
          "ignore_missing" : true
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "kibana.log.meta.res.contentLength",
          "target_field" : "http.response.body.bytes"
        }
      },
      {
        "rename" : {
          "target_field" : "http.request.method",
          "ignore_missing" : true,
          "field" : "kibana.log.meta.req.method"
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.req.headers.referer",
          "target_field" : "http.request.referrer",
          "ignore_missing" : true
        }
      },
      {
        "rename" : {
          "ignore_missing" : true,
          "field" : "kibana.log.meta.req.headers.user-agent",
          "target_field" : "user_agent.original"
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.req.remoteAddress",
          "target_field" : "source.address",
          "ignore_missing" : true
        }
      },
      {
        "set" : {
          "field" : "source.ip",
          "value" : "{{source.address}}",
          "ignore_empty_value" : true
        }
      },
      {
        "rename" : {
          "field" : "kibana.log.meta.req.url",
          "target_field" : "url.original",
          "ignore_missing" : true
        }
      },
      {
        "remove" : {
          "field" : "kibana.log.meta.req.referer",
          "ignore_missing" : true
        }
      },
      {
        "remove" : {
          "field" : "kibana.log.meta.statusCode",
          "ignore_missing" : true
        }
      },
      {
        "remove" : {
          "field" : "kibana.log.meta.method",
          "ignore_missing" : true
        }
      },
      {
        "append" : {
          "value" : "kibana",
          "field" : "service.name"
        }
      },
      {
        "set" : {
          "value" : "event",
          "field" : "event.kind"
        }
      },
      {
        "script" : {
          "source" : "if (ctx?.kibana?.log?.state != null) {\n  if (ctx.kibana.log.state == \"red\") {\n    ctx.event.type = \"error\";\n  } else {\n    ctx.event.type = \"info\";\n  }\n}",
          "lang" : "painless"
        }
      },
      {
        "set" : {
          "field" : "event.outcome",
          "value" : "success",
          "if" : "ctx?.http?.response?.status_code != null && ctx.http.response.status_code < 400"
        }
      },
      {
        "set" : {
          "field" : "event.outcome",
          "value" : "failure",
          "if" : "ctx?.http?.response?.status_code != null && ctx.http.response.status_code >= 400"
        }
      }
    ]
  }
