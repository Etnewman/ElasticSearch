{
    "processors" : [
      {
        "set" : {
          "field" : "@timestamp",
          "value" : "{{kibana._audit_temp.@timestamp}}"
        }
      },
      {
        "set" : {
          "field" : "message",
          "value" : "{{kibana._audit_temp.message}}"
        }
      },
      {
        "set" : {
          "field" : "event.action",
          "value" : "{{kibana._audit_temp.event.action}}",
          "if" : "ctx.kibana._audit_temp.event.action != null"
        }
      },
      {
        "set" : {
          "value" : "{{kibana._audit_temp.event.category.0}}",
          "if" : "ctx.kibana._audit_temp.event.category != null && ctx.kibana._audit_temp.event.category instanceof List",
          "field" : "event.category"
        }
      },
      {
        "set" : {
          "value" : "{{kibana._audit_temp.event.category}}",
          "if" : "ctx.kibana._audit_temp.event.category != null && ctx.kibana._audit_temp.event.category instanceof String",
          "field" : "event.category"
        }
      },
      {
        "set" : {
          "value" : "{{kibana._audit_temp.event.outcome}}",
          "if" : "ctx.kibana._audit_temp.event.outcome != null",
          "field" : "event.outcome"
        }
      },
      {
        "set" : {
          "if" : "ctx.kibana._audit_temp.event.type != null && ctx.kibana._audit_temp.event.type instanceof List",
          "field" : "event.type",
          "value" : "{{kibana._audit_temp.event.type.0}}"
        }
      },
      {
        "set" : {
          "field" : "event.type",
          "value" : "{{kibana._audit_temp.event.type}}",
          "if" : "ctx.kibana._audit_temp.event.type != null && ctx.kibana._audit_temp.event.type instanceof String"
        }
      },
      {
        "remove" : {
          "field" : "ecs"
        }
      },
      {
        "rename" : {
          "target_field" : "ecs",
          "if" : "ctx.kibana._audit_temp.ecs != null",
          "field" : "kibana._audit_temp.ecs"
        }
      },
      {
        "rename" : {
          "field" : "kibana._audit_temp.url",
          "target_field" : "url",
          "if" : "ctx.kibana._audit_temp.url != null"
        }
      },
      {
        "set" : {
          "if" : "ctx.url?.query == null",
          "field" : "url.original",
          "value" : "{{url.path}}",
          "ignore_empty_value" : true
        }
      },
      {
        "set" : {
          "if" : "ctx.url?.path != null && ctx.url?.query != null",
          "field" : "url.original",
          "value" : "{{url.path}}?{{url.query}}"
        }
      },
      {
        "rename" : {
          "if" : "ctx.kibana._audit_temp.http != null",
          "field" : "kibana._audit_temp.http",
          "target_field" : "http"
        }
      },
      {
        "rename" : {
          "if" : "ctx.kibana._audit_temp.user != null",
          "field" : "kibana._audit_temp.user",
          "target_field" : "user"
        }
      },
      {
        "rename" : {
          "if" : "ctx.kibana._audit_temp.trace != null",
          "field" : "kibana._audit_temp.trace",
          "target_field" : "trace"
        }
      },
      {
        "rename" : {
          "field" : "kibana._audit_temp.process",
          "if" : "ctx.kibana._audit_temp.process?.pid != null",
          "target_field" : "process"
        }
      },
      {
        "rename" : {
          "if" : "ctx.kibana._audit_temp.error != null",
          "target_field" : "error",
          "field" : "kibana._audit_temp.error"
        }
      },
      {
        "rename" : {
          "target_field" : "kibana.session_id",
          "field" : "kibana._audit_temp.kibana.session_id",
          "if" : "ctx.kibana._audit_temp.kibana.session_id != null"
        }
      },
      {
        "rename" : {
          "target_field" : "kibana.space_id",
          "field" : "kibana._audit_temp.kibana.space_id",
          "if" : "ctx.kibana._audit_temp.kibana.space_id != null"
        }
      },
      {
        "rename" : {
          "field" : "kibana._audit_temp.kibana.saved_object",
          "if" : "ctx.kibana._audit_temp.kibana.saved_object != null",
          "target_field" : "kibana.saved_object"
        }
      },
      {
        "rename" : {
          "target_field" : "kibana.add_to_spaces",
          "field" : "kibana._audit_temp.kibana.add_to_spaces",
          "if" : "ctx.kibana._audit_temp.kibana.add_to_spaces != null"
        }
      },
      {
        "rename" : {
          "if" : "ctx.kibana._audit_temp.kibana.delete_from_spaces != null",
          "target_field" : "kibana.delete_from_spaces",
          "field" : "kibana._audit_temp.kibana.delete_from_spaces"
        }
      },
      {
        "remove" : {
          "field" : "kibana._audit_temp"
        }
      }
    ],
    "on_failure" : [
      {
        "set" : {
          "field" : "error.message",
          "value" : "{{ _ingest.on_failure_message }}"
        }
      }
    ],
    "description" : "Pipeline for parsing Kibana audit logs in JSON format"
  }
